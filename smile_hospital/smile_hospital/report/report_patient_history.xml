<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_patient_history_template">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="web.external_layout">
                    <style>
                        .patient-report {
                            font-family: 'Helvetica Neue', Arial, sans-serif;
                            color: #333;
                            line-height: 1.5;
                        }

                        .report-header {
                            text-align: center;
                            margin-bottom: 25px;
                            padding-bottom: 15px;
                            border-bottom: 1px solid #e6e6e6;
                        }

                        .report-title {
                            font-size: 26px;
                            font-weight: bold;
                            margin: 0;
                            color: #333;
                            text-transform: uppercase;
                        }

                        .patient-info {
                            margin-bottom: 20px;
                            padding: 10px 15px;
                            background-color: #f9f9f9;
                            border-radius: 3px;
                            border: 1px solid #e6e6e6;
                            display: flex;
                            justify-content: space-between;
                        }

                        .patient-info p {
                            margin: 3px 0;
                            font-size: 14px;
                        }

                        .report-section {
                            margin-top: 25px;
                        }

                        .section-title {
                            font-size: 18px;
                            font-weight: 600;
                            margin-bottom: 10px;
                            border-bottom: 2px solid #ccc;
                            padding-bottom: 5px;
                        }

                        .report-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 13px;
                            margin-bottom: 20px;
                        }

                        .report-table th {
                            background-color: #f9f9f9;
                            color: #333;
                            font-weight: 600;
                            padding: 10px;
                            text-align: left;
                            border: 1px solid #e6e6e6;
                        }

                        .report-table td {
                            padding: 8px;
                            border: 1px solid #e6e6e6;
                            vertical-align: top;
                        }

                        .report-table tr:nth-child(even) {
                            background-color: #fafafa;
                        }

                        .currency-cell {
                            text-align: right;
                        }

                        .xray-img {
                            max-width: 100px;
                            max-height: 80px;
                            border: 1px solid #ccc;
                            border-radius: 4px;
                        }
                    </style>

                    <div class="patient-report">
                        <!-- Report Header -->
                        <div class="report-header">
                            <h1 class="report-title">Patient Summary Report</h1>
                        </div>

                        <!-- Patient Info -->
                        <div class="patient-info"
                             style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">

                            <!-- Left side: patient details -->
                            <div style="flex:1;">
                                <p>
                                    <strong>Name:</strong>
                                    <t t-esc="doc.name"/>
                                </p>
                                <p>
                                    <strong>Patient No:</strong>
                                    <t t-esc="doc.patient_no"/>
                                </p>
                                <p>
                                    <strong>Age:</strong>
                                    <t t-esc="doc.patient_age"/>
                                </p>
                                <p>
                                    <strong>Mobile:</strong>
                                    <t t-esc="doc.mobile"/>
                                </p>
                                <p>
                                    <strong>Date:</strong>
                                    <t t-esc="time.strftime('%Y-%m-%d')"/>
                                </p>
                            </div>

                            <!-- Right side: patient image -->
                            <div style="margin-left:20px; text-align:right;">
                                <t t-if="doc.image_1920">
                                    <img t-att-src="'data:image/png;base64,%s' % (doc.image_1920.decode() if isinstance(doc.image_1920, bytes) else doc.image_1920)"
                                         style="width:120px; height:120px; border:1px solid #ccc; border-radius:5px; object-fit:cover;"/>
                                </t>
                            </div>

                        </div>


                        <!-- Procedures -->
                        <div class="report-section">
                            <h4 class="section-title">Procedures</h4>
                            <table class="report-table">
                                <thead>
                                    <tr><th>Date</th><th>Doctor</th><th>Status</th><th>Reason</th></tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.procedure_ids" t-as="proc">
                                        <tr>
                                            <td><t t-esc="proc.date"/></td>
                                            <td><t t-esc="proc.doctor_id.name"/></td>
                                            <td><t t-esc="proc.status"/></td>
                                            <td><t t-esc="proc.reason"/></td>
                                        </tr>
                                    </t>
                                    <t t-if="not doc.procedure_ids">
                                        <tr><td colspan="4">No procedures recorded.</td></tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- Medical Questionnaire -->
                        <div class="report-section">
                            <h4 class="section-title">Medical Questionnaire</h4>
                            <table class="report-table">
                                <thead>
                                    <tr><th>Question</th><th>Answer</th><th>Reason</th></tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.medical_questionnaire_ids" t-as="ques">
                                        <tr>
                                            <td><t t-esc="ques.question_id.question"/></td>
                                            <td><t t-esc="ques.yes_no"/></td>
                                            <td><t t-esc="ques.reason or '-'"/></td>
                                        </tr>
                                    </t>
                                    <t t-if="not doc.medical_questionnaire_ids">
                                        <tr><td colspan="3">No questionnaire answers found.</td></tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- Prescriptions -->
                        <div class="report-section">
                            <h4 class="section-title">Prescriptions</h4>
                            <t t-set="prescriptions" t-value="patient_data.get(doc.id).get('prescriptions')"/>
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Doctor</th>
                                        <th>Treatment</th>
                                        <th>Medicines</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="prescriptions" t-as="pres">
                                        <tr>
                                            <td>
                                                <t t-esc="pres.prescription_date"/>
                                            </td>
                                            <td>
                                                <t t-esc="pres.prescribed_doctor_id.name"/>
                                            </td>
                                            <td>
                                                <t t-esc="', '.join(pres.treatment_id.mapped('name'))"/>
                                            </td>
                                            <td>
                                                <ul style="margin:0; padding-left:15px;">
                                                    <t t-foreach="pres.medicine_ids" t-as="line">
                                                        <li>
                                                            <t t-esc="line.medicament_id.name"/>
                                                            —
                                                            <t t-esc="line.quantity"/>
                                                            Qty
                                                            (for
                                                            <t t-esc="line.days or 0.0"/>
                                                            days)
                                                        </li>
                                                    </t>
                                                </ul>
                                            </td>
                                        </tr>
                                    </t>
                                    <t t-if="not prescriptions">
                                        <tr>
                                            <td colspan="4">No prescriptions found.</td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- Invoices -->
                        <div class="report-section">
                            <h4 class="section-title">Invoices</h4>
                            <table class="report-table">
                                <thead>
                                    <tr><th>Invoice</th><th>Date</th><th>Total</th><th>Paid</th><th>Balance</th></tr>
                                </thead>
                                <tbody>
                                    <t t-set="invoices" t-value="patient_data.get(doc.id).get('invoices')"/>
                                    <t t-foreach="invoices" t-as="inv">
                                        <tr>
                                            <td><t t-esc="inv.name"/></td>
                                            <td><t t-esc="inv.invoice_date or inv.create_date"/></td>
                                            <td class="currency-cell"><t t-esc="inv.amount_total"/></td>
                                            <td class="currency-cell"><t t-esc="inv.amount_total - inv.amount_residual"/></td>
                                            <td class="currency-cell"><t t-esc="inv.amount_residual"/></td>
                                        </tr>
                                    </t>
                                    <t t-if="not invoices">
                                        <tr><td colspan="5">No invoices found.</td></tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>

                        <!-- X-Ray Reports -->
                        <div class="report-section">
                            <h4 class="section-title">X-Ray Reports</h4>
                            <table class="report-table">
                                <thead>
                                    <tr><th>Date</th><th>Description</th><th>Image</th></tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="doc.report_ids" t-as="xray">
                                        <tr>
                                            <td><t t-esc="xray.report_date or '-'"/></td>
                                            <td><t t-esc="xray.description or '-'"/></td>
                                            <td>
                                                <t t-if="xray.scan_image">
                                                    <img t-att-src="'data:image/png;base64,%s' % (xray.scan_image.decode() if isinstance(xray.scan_image, bytes) else xray.scan_image)" class="xray-img"/>
                                                </t>
                                                <t t-else="">No image</t>
                                            </td>
                                        </tr>
                                    </t>
                                    <t t-if="not doc.report_ids">
                                        <tr><td colspan="3">No X-Ray reports found.</td></tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>



<!--<p>• <strong>Date:</strong> <span t-esc="proc.date"/> |-->
<!--                                   <strong>Doctor:</strong> <span t-esc="proc.doctor_id.name"/> |-->
<!--                                   <strong>Status:</strong> <span t-esc="proc.status"/> |-->
<!--                                   <strong>Reason:</strong> <span t-esc="proc.reason"/>-->
<!--                                </p>-->